function p(h,t,n=100,i=[],s=0){let o=h-n,e=h+t+n,l=f(o,i),r=f(e,i);return[Math.max(0,l-s),Math.min(i.length-1,r+s)]}function f(h,t){let n=0,i=t.length-1,s=t.length;for(;n<=i;){let o=Math.floor((n+i)/2);t[o].y>=h?(s=o,i=o-1):n=o+1}return s}function g(h,t){new IntersectionObserver(([i],s)=>{i.isIntersecting?(h.firstElementChild&&h.firstElementChild.classList.add(t),s.unobserve(h)):h.firstElementChild&&h.firstElementChild.classList.remove(t)},{root:this.el,threshold:.1}).observe(h)}function y(h,t,n=!1){let i=null,s=!1;return function(...o){let e=this;n&&!i&&!s&&(h.apply(e,o),s=!0),i!==null&&clearTimeout(i),i=setTimeout(()=>{n||h.apply(e,o),i=null,s=!1},t)}}function b(h,t,n={}){let i=null,s=0,o,e,l=()=>{s=n.leading===!1?0:Date.now(),i=null,h.apply(o,e),o=e=null},r=function(...c){let a=Date.now();!s&&n.leading===!1&&(s=a);let d=t-(a-s);o=this,e=c,d<=0||d>t?(i&&(clearTimeout(i),i=null),s=a,h.apply(o,e),o=e=null):!i&&n.trailing!==!1&&(i=setTimeout(l,d))};return r.cancel=()=>{clearTimeout(i),i=null,s=0},r}function T(h){return new u(h)}var u=class{constructor(t){this.config=t,this.el=typeof t.el=="string"?document.querySelector(t.el):t.el,this.colHeights=Array(t.column).fill(0),this.totalHeight=0,this.colWidth=0,this.content=null,this.activeMap=new Map,this.domPool=new Map,this.viewportHeight=this.config.viewportHeight,this.MAX_DOM_POOL_SIZE=this.config.maxDomPoolSize||300,this._pendingObservers=[],this._observerTimer=null,this._ticking=!1,this.isUpdate=!1,this._initData(t)}async _initData(t){typeof t.data=="function"?this.data=await t.data():this.data=t.data,this._onScrollThrottled=b(this._onScroll.bind(this),100),this._init_el(),this._debouncedRecalculate=y(this._init.bind(this),200),this.el.addEventListener("scroll",this._onScrollThrottled),this.resizeObserver=new ResizeObserver(()=>this._debouncedRecalculate()),this.resizeObserver.observe(this.el)}_init_el(){this.el.style.cssText=`overflow-y: scroll;height: ${this.viewportHeight}px;`;let t=document.createElement("div");t.className="content",t.style.cssText="position: relative;width: 100%;",this.el.appendChild(t),this.content=t}async _init(){this.colHeights=Array(this.config.column).fill(0),this.totalHeight=0;let t=this.data,{renderItem:n,gap:i,column:s}=this.config,o=Math.floor((this.el.clientWidth-(s-1)*i)/this.config.column);this.colWidth=o;for(let e=0;e<t.length;e++){let l=n(t[e]);l.style.width=o+"px";let r=await this._measure(l),c=this.colHeights.indexOf(Math.min(...this.colHeights)),a=Math.floor(c*(o+i)),d=Math.floor(this.colHeights[c]);t[e].height=r,t[e].x=a,t[e].y=d,t[e].width=o,this.colHeights[c]+=r+i;let m=this.activeMap.get(e);m&&(m.style.width=`${this.colWidth}px`,m.style.transform=`translate3d(${a}px, ${d}px, 0)`)}this.data=t,this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",requestAnimationFrame(()=>{this._onScroll()})}async updateData(t){let{renderItem:n,gap:i}=this.config,s=this.colWidth;for(let o=0;o<t.length;o++){let e=n(t[o]);e.style.width=s+"px";let l=await this._measure(e),r=this.colHeights.indexOf(Math.min(...this.colHeights)),c=Math.floor(r*(s+i)),a=Math.floor(this.colHeights[r]);t[o].height=l,t[o].x=c,t[o].y=a,t[o].width=s,this.colHeights[r]+=l+i}this.data.push(...t),this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",requestAnimationFrame(()=>{this._onScroll()})}async _measure(t){let n=document.createElement("div");n.style.cssText="position:absolute;visibility:hidden;pointer-events:none;",n.appendChild(t),document.body.appendChild(n);let i=t.querySelectorAll("img");i.length>0&&await Promise.all([...i].map(o=>new Promise(e=>{o.onload=o.onerror=e})));let s=Math.floor(t.offsetHeight);return document.body.removeChild(n),s}_setElementStyle(t,{x:n,y:i,width:s}){t.style.width=s+"px",t.style.transform=`translate3d(${n}px, ${i}px, 0)`}_onScroll(){let t=this.el.scrollTop,n=this.config.buffer||300,[i,s]=p(t,this.viewportHeight,n,this.data,this.config.column);for(let[e,l]of this.activeMap.entries())(e<i||e>s)&&(this.content.removeChild(l),this.activeMap.delete(e));let o=document.createDocumentFragment();this._pendingObservers||(this._pendingObservers=[]);for(let e=i;e<=s;e++)if(!this.activeMap.has(e)){let l=this.domPool.get(e);l||(l=this.config.renderItem(this.data[e]),this.domPool.set(e,l));let r=this.data[e];l.style.position="absolute",this._setElementStyle(l,{width:r.width,x:r.x,y:r.y}),this.activeMap.set(e,l),o.appendChild(l),this._pendingObservers.push(l)}if(this.content.appendChild(o),cancelAnimationFrame(this._observerTimer),this._observerTimer=requestAnimationFrame(()=>{this._pendingObservers.forEach(e=>g.call(this,e,this.config.animeClass)),this._pendingObservers=[]}),this.domPool.size>this.MAX_DOM_POOL_SIZE){let e=[...this.domPool.keys()];for(let l=0;l<e.length-this.MAX_DOM_POOL_SIZE;l++){let r=e[l];this.activeMap.has(r)||this.domPool.delete(r)}}this.isScrollBottom()}async isScrollBottom(){let t=this.el;if(t.scrollTop+t.clientHeight>=t.scrollHeight-50&&!this.isUpdate&&this.config.scrollToBottom){this.isUpdate=!0;try{let s=await this.config.scrollToBottom();s.length&&await this.updateData(s)}finally{this.isUpdate=!1}}}};export{T as SuperVirtual};
//# sourceMappingURL=super-virtual-list.js.map
