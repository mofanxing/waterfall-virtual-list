function g(l,t,s=100,i=[],r=0){let n=l-s,e=l+t+s,o=u(n,i),h=u(e,i);return[Math.max(0,o-r),Math.min(i.length-1,h+r)]}function u(l,t){let s=0,i=t.length-1,r=t.length;for(;s<=i;){let n=Math.floor((s+i)/2);t[n].y>=l?(r=n,i=n-1):s=n+1}return r}function p(l){new IntersectionObserver(([s],i)=>{s.isIntersecting?(l.firstElementChild&&l.firstElementChild.classList.add("fade-in"),i.unobserve(l)):l.firstElementChild&&l.firstElementChild.classList.remove("fade-in")},{root:this.el,threshold:.1}).observe(l)}function b(l,t,s=!1){let i=null,r=!1;return function(...n){let e=this;s&&!i&&!r&&(l.apply(e,n),r=!0),i!==null&&clearTimeout(i),i=setTimeout(()=>{s||l.apply(e,n),i=null,r=!1},t)}}function y(l){return new d(l)}var d=class{constructor(t){this.config=t,this.el=typeof t.el=="string"?document.querySelector(t.el):t.el,this.colHeights=Array(t.column).fill(0),this.totalHeight=0,this.colWidth=0,this.content=null,this.activeMap=new Map,this.domPool=new Map,this.viewportHeight=this.config.viewportHeight,this.MAX_DOM_POOL_SIZE=this.config.maxDomPoolSize||300,this._pendingObservers=[],this._observerTimer=null,this._ticking=!1,this._init_el(),this._debouncedRecalculate=b(this._init.bind(this),200),this.el.addEventListener("scroll",()=>this._onScrollThrottled()),this.resizeObserver=new ResizeObserver(()=>this._debouncedRecalculate()),this.resizeObserver.observe(this.el)}_init_el(){this.el.style.cssText=`overflow-y: scroll;height: ${this.viewportHeight}px;`;let t=document.createElement("div");t.className="content",t.style.cssText="position: relative;width: 100%;",this.el.appendChild(t),this.content=t}async _init(){this.colHeights=Array(this.config.column).fill(0),this.totalHeight=0;let{data:t,renderItem:s,gap:i,column:r}=this.config,n=Math.floor((this.el.clientWidth-(r-1)*i)/this.config.column);this.colWidth=n;for(let e=0;e<t.length;e++){let o=s(t[e]);o.style.width=this.colWidth+"px";let h=await this._measure(o),a=this.colHeights.indexOf(Math.min(...this.colHeights)),m=Math.floor(a*(n+i)),f=Math.floor(this.colHeights[a]);t[e].height=h,t[e].x=m,t[e].y=f,t[e].width=n,this.colHeights[a]+=h+i;let c=this.activeMap.get(e);c&&(c.style.width=`${this.colWidth}px`,c.style.transform=`translate3d(${m}px, ${f}px, 0)`)}this.config.data=t,this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",console.log(this.config.data),this._onScroll()}async _measure(t){let s=document.createElement("div");s.style.cssText="position:absolute;visibility:hidden;pointer-events:none;",s.appendChild(t),document.body.appendChild(s);let i=t.querySelectorAll("img");i.length>0&&await Promise.all([...i].map(n=>new Promise(e=>{n.onload=n.onerror=e})));let r=Math.floor(t.offsetHeight);return document.body.removeChild(s),r}_onScroll(){let t=this.el.scrollTop,s=this.config.buffer||300,[i,r]=g(t,this.viewportHeight,s,this.config.data,this.config.column);for(let[e,o]of this.activeMap.entries())(e<i||e>r)&&(this.content.removeChild(o),this.activeMap.delete(e));let n=document.createDocumentFragment();this._pendingObservers||(this._pendingObservers=[]);for(let e=i;e<=r;e++)if(!this.activeMap.has(e)){let o=this.domPool.get(e);o||(o=this.config.renderItem(this.config.data[e]),this.domPool.set(e,o));let h=this.config.data[e];o.style.position="absolute",o.style.width=h.width+"px",o.style.transform=`translate3d(${h.x}px, ${h.y}px, 0)`,this.activeMap.set(e,o),n.appendChild(o),this._pendingObservers.push(o)}if(this.content.appendChild(n),cancelAnimationFrame(this._observerTimer),this._observerTimer=requestAnimationFrame(()=>{this._pendingObservers.forEach(e=>p.call(this,e)),this._pendingObservers=[]}),this.domPool.size>this.MAX_DOM_POOL_SIZE){let e=[...this.domPool.keys()];for(let o=0;o<e.length-this.MAX_DOM_POOL_SIZE;o++){let h=e[o];this.activeMap.has(h)||this.domPool.delete(h)}}}_onScrollThrottled(){this._ticking||(this._ticking=!0,requestAnimationFrame(()=>{this._onScroll(),this._ticking=!1}))}};export{y as SuperVirtual};
//# sourceMappingURL=super-virtual-list.js.map
