function p(h,t,n=100,i=[],o=0){let s=h-n,e=h+t+n,l=f(s,i),r=f(e,i);return[Math.max(0,l-o),Math.min(i.length-1,r+o)]}function f(h,t){let n=0,i=t.length-1,o=t.length;for(;n<=i;){let s=Math.floor((n+i)/2);t[s].y>=h?(o=s,i=s-1):n=s+1}return o}function g(h){new IntersectionObserver(([n],i)=>{n.isIntersecting?(h.firstElementChild&&h.firstElementChild.classList.add("fade-in"),i.unobserve(h)):h.firstElementChild&&h.firstElementChild.classList.remove("fade-in")},{root:this.el,threshold:.1}).observe(h)}function y(h,t,n=!1){let i=null,o=!1;return function(...s){let e=this;n&&!i&&!o&&(h.apply(e,s),o=!0),i!==null&&clearTimeout(i),i=setTimeout(()=>{n||h.apply(e,s),i=null,o=!1},t)}}function b(h,t,n={}){let i=null,o=0,s,e,l=()=>{o=n.leading===!1?0:Date.now(),i=null,h.apply(s,e),s=e=null},r=function(...c){let a=Date.now();!o&&n.leading===!1&&(o=a);let d=t-(a-o);s=this,e=c,d<=0||d>t?(i&&(clearTimeout(i),i=null),o=a,h.apply(s,e),s=e=null):!i&&n.trailing!==!1&&(i=setTimeout(l,d))};return r.cancel=()=>{clearTimeout(i),i=null,o=0},r}function T(h){return new u(h)}var u=class{constructor(t){this.config=t,this.el=typeof t.el=="string"?document.querySelector(t.el):t.el,this.colHeights=Array(t.column).fill(0),this.totalHeight=0,this.colWidth=0,this.content=null,this.activeMap=new Map,this.domPool=new Map,this.viewportHeight=this.config.viewportHeight,this.MAX_DOM_POOL_SIZE=this.config.maxDomPoolSize||300,this._pendingObservers=[],this._observerTimer=null,this._ticking=!1,this.isUpdate=!1,this._initData(t)}async _initData(t){typeof t.data=="function"?this.data=await t.data():this.data=t.data,this._onScrollThrottled=b(this._onScroll.bind(this),100),this._init_el(),this._debouncedRecalculate=y(this._init.bind(this),200),this.el.addEventListener("scroll",this._onScrollThrottled),this.resizeObserver=new ResizeObserver(()=>this._debouncedRecalculate()),this.resizeObserver.observe(this.el)}_init_el(){this.el.style.cssText=`overflow-y: scroll;height: ${this.viewportHeight}px;`;let t=document.createElement("div");t.className="content",t.style.cssText="position: relative;width: 100%;",this.el.appendChild(t),this.content=t}async _init(){this.colHeights=Array(this.config.column).fill(0),this.totalHeight=0;let t=this.data,{renderItem:n,gap:i,column:o}=this.config,s=Math.floor((this.el.clientWidth-(o-1)*i)/this.config.column);this.colWidth=s;for(let e=0;e<t.length;e++){let l=n(t[e]);l.style.width=s+"px";let r=await this._measure(l),c=this.colHeights.indexOf(Math.min(...this.colHeights)),a=Math.floor(c*(s+i)),d=Math.floor(this.colHeights[c]);t[e].height=r,t[e].x=a,t[e].y=d,t[e].width=s,this.colHeights[c]+=r+i;let m=this.activeMap.get(e);m&&(m.style.width=`${this.colWidth}px`,m.style.transform=`translate3d(${a}px, ${d}px, 0)`)}this.data=t,this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",requestAnimationFrame(()=>{this._onScroll()})}async updateData(t){let{renderItem:n,gap:i}=this.config,o=this.colWidth;for(let s=0;s<t.length;s++){let e=n(t[s]);e.style.width=o+"px";let l=await this._measure(e),r=this.colHeights.indexOf(Math.min(...this.colHeights)),c=Math.floor(r*(o+i)),a=Math.floor(this.colHeights[r]);t[s].height=l,t[s].x=c,t[s].y=a,t[s].width=o,this.colHeights[r]+=l+i}this.data.push(...t),this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",requestAnimationFrame(()=>{this._onScroll()})}async _measure(t){let n=document.createElement("div");n.style.cssText="position:absolute;visibility:hidden;pointer-events:none;",n.appendChild(t),document.body.appendChild(n);let i=t.querySelectorAll("img");i.length>0&&await Promise.all([...i].map(s=>new Promise(e=>{s.onload=s.onerror=e})));let o=Math.floor(t.offsetHeight);return document.body.removeChild(n),o}_setElementStyle(t,{x:n,y:i,width:o}){t.style.width=o+"px",t.style.transform=`translate3d(${n}px, ${i}px, 0)`}_onScroll(){let t=this.el.scrollTop,n=this.config.buffer||300,[i,o]=p(t,this.viewportHeight,n,this.data,this.config.column);for(let[e,l]of this.activeMap.entries())(e<i||e>o)&&(this.content.removeChild(l),this.activeMap.delete(e));let s=document.createDocumentFragment();this._pendingObservers||(this._pendingObservers=[]);for(let e=i;e<=o;e++)if(!this.activeMap.has(e)){let l=this.domPool.get(e);l||(l=this.config.renderItem(this.data[e]),this.domPool.set(e,l));let r=this.data[e];l.style.position="absolute",this._setElementStyle(l,{width:r.width,x:r.x,y:r.y}),this.activeMap.set(e,l),s.appendChild(l),this._pendingObservers.push(l)}if(this.content.appendChild(s),cancelAnimationFrame(this._observerTimer),this._observerTimer=requestAnimationFrame(()=>{this._pendingObservers.forEach(e=>g.call(this,e)),this._pendingObservers=[]}),this.domPool.size>this.MAX_DOM_POOL_SIZE){let e=[...this.domPool.keys()];for(let l=0;l<e.length-this.MAX_DOM_POOL_SIZE;l++){let r=e[l];this.activeMap.has(r)||this.domPool.delete(r)}}this.isScrollBottom()}async isScrollBottom(){let t=this.el;if(t.scrollTop+t.clientHeight>=t.scrollHeight-50&&!this.isUpdate){this.isUpdate=!0;try{let o=await this.config.scrollToBottom();o.length&&await this.updateData(o)}finally{this.isUpdate=!1}}}};export{T as SuperVirtual};
//# sourceMappingURL=super-virtual-list.js.map
