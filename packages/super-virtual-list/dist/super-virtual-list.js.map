{
  "version": 3,
  "sources": ["../../shared/src/index.ts", "../src/super-virtual-list.ts"],
  "sourcesContent": ["export function _getVisibleRange(\n  scrollTop,\n  viewportHeight,\n  buffer = 100,\n  data = [],\n  overscanCount = 0\n) {\n  const visibleTop = scrollTop - buffer;\n  const visibleBottom = scrollTop + viewportHeight + buffer;\n  const start = _binarySearch(visibleTop, data);\n  const end = _binarySearch(visibleBottom, data);\n  return [\n    Math.max(0, start - overscanCount),\n    Math.min(data.length - 1, end + overscanCount),\n  ];\n}\n\nfunction _binarySearch(targetY, data) {\n  let low = 0,\n    high = data.length - 1;\n  let result = data.length;\n\n  while (low <= high) {\n    const mid = Math.floor((low + high) / 2);\n    if (data[mid].y >= targetY) {\n      result = mid;\n      high = mid - 1;\n    } else {\n      low = mid + 1;\n    }\n  }\n  return result;\n}\n\nexport function observeVisibility(el) {\n  const observer = new IntersectionObserver(\n    ([entry], obs) => {\n      if (entry.isIntersecting) {\n        //\u7ED9\u7B2C\u4E00\u4E2A\u5B50\u5143\u7D20\u6DFB\u52A0\u52A8\u753B\n        if (el.firstElementChild) {\n          el.firstElementChild.classList.add(\"fade-in\");\n        }\n        obs.unobserve(el);\n      }else{\n        if (el.firstElementChild) {\n          el.firstElementChild.classList.remove(\"fade-in\");\n        }\n      }\n      \n    },\n    {\n      root: this.el, // \u8BBE\u7F6E\u4E3A\u6EDA\u52A8\u5BB9\u5668\n      threshold: 0.1, // \u6709 10% \u53EF\u89C1\u5C31\u89E6\u53D1\n    }\n  );\n\n  observer.observe(el);\n}\n\n/**\n * \u521B\u5EFA\u4E00\u4E2A\u9632\u6296\u51FD\u6570\uFF0C\u8BE5\u51FD\u6570\u5728\u6307\u5B9A\u7684\u5EF6\u8FDF\u65F6\u95F4\u5185\u6CA1\u6709\u518D\u6B21\u8C03\u7528\u65F6\uFF0C\u624D\u4F1A\u6267\u884C\u539F\u59CB\u51FD\u6570\u3002\n * @param func - \u8981\u8FDB\u884C\u9632\u6296\u5904\u7406\u7684\u51FD\u6570\u3002\n * @param delay - \u5EF6\u8FDF\u65F6\u95F4\uFF0C\u5355\u4F4D\u4E3A\u6BEB\u79D2\u3002\n * @returns \u9632\u6296\u540E\u7684\u51FD\u6570\u3002\n */\nexport function debounce<T extends (...args: any[]) => any>(\n  func: T,\n  delay: number,\n  immediate: boolean = false\n): (...args: Parameters<T>) => void {\n  let timer: ReturnType<typeof setTimeout> | null = null;\n  let hasCalled = false;\n\n  return function (this: ThisParameterType<T>, ...args: Parameters<T>) {\n    const context = this;\n\n    // \u5982\u679C\u9700\u8981\u7ACB\u5373\u6267\u884C\u4E14\u8FD8\u6CA1\u6709\u6267\u884C\u8FC7\n    if (immediate && !timer && !hasCalled) {\n      func.apply(context, args);\n      hasCalled = true;\n    }\n\n    if (timer !== null) {\n      clearTimeout(timer);\n    }\n\n    timer = setTimeout(() => {\n      if (!immediate) {\n        func.apply(context, args);\n      }\n      timer = null;\n      hasCalled = false; // \u91CD\u7F6E\uFF0C\u5141\u8BB8\u4E0B\u4E00\u6B21\u7ACB\u5373\u6267\u884C\n    }, delay);\n  };\n}\n", "import { SuperVirtualListConfig } from \"./types\";\nimport { _getVisibleRange, observeVisibility, debounce } from \"@virtual/shared\";\nexport function SuperVirtual(config: SuperVirtualListConfig) {\n  return new SuperVirtualList(config);\n}\n\nclass SuperVirtualList {\n  el: HTMLElement;\n  content: HTMLElement | null;\n  config: SuperVirtualListConfig;\n  colWidth: number;\n  colHeights: number[];\n  totalHeight: number;\n  activeMap: Map<number, HTMLElement>;\n  domPool: Map<number, HTMLElement>;\n  viewportHeight: number;\n  _ticking: boolean;\n  _pendingObservers: HTMLElement[];\n  _observerTimer: any;\n  MAX_DOM_POOL_SIZE: number;\n  resizeObserver: ResizeObserver;\n  _debouncedRecalculate: () => void;\n\n  constructor(config: SuperVirtualListConfig) {\n    this.config = config;\n    this.el =\n      typeof config.el === \"string\"\n        ? document.querySelector(config.el)\n        : config.el;\n    this.colHeights = Array(config.column).fill(0);\n    this.totalHeight = 0;\n    this.colWidth = 0;\n    this.content = null;\n    this.activeMap = new Map(); // \u6E32\u67D3\u4E2D\u7684 DOM\n    this.domPool = new Map();\n    this.viewportHeight = this.config.viewportHeight;\n    this.MAX_DOM_POOL_SIZE = this.config.maxDomPoolSize || 300;\n    this._pendingObservers = [];\n    this._observerTimer = null;\n    this._ticking = false;\n\n    this._init_el();\n    this._debouncedRecalculate = debounce(\n      this._init.bind(this),\n      200\n    );\n    this.el.addEventListener(\"scroll\", () => this._onScrollThrottled());\n    this.resizeObserver = new ResizeObserver(() =>\n      this._debouncedRecalculate()\n    );\n    this.resizeObserver.observe(this.el);\n  }\n  _init_el() {\n    this.el.style.cssText = `overflow-y: scroll;height: ${this.viewportHeight}px;`;\n    let content = document.createElement(\"div\");\n    content.className = \"content\";\n    content.style.cssText = \"position: relative;width: 100%;\";\n    this.el.appendChild(content);\n    this.content = content;\n  }\n  async _init() {\n    this.colHeights = Array(this.config.column).fill(0);\n    this.totalHeight = 0;\n\n    let { data, renderItem, gap, column } = this.config;\n    let width = Math.floor(\n      (this.el.clientWidth - (column - 1) * gap) / this.config.column\n    );\n    this.colWidth = width;\n    for (let i = 0; i < data.length; i++) {\n      const el = renderItem(data[i]);\n      el.style.width = this.colWidth + \"px\";\n      const measuredHeight = await this._measure(el);\n      const minCol = this.colHeights.indexOf(Math.min(...this.colHeights));\n      const x = Math.floor(minCol * (width + gap));\n      const y = Math.floor(this.colHeights[minCol]);\n      data[i].height = measuredHeight;\n      data[i].x = x;\n      data[i].y = y;\n      data[i].width = width;\n      this.colHeights[minCol] += measuredHeight + gap;\n\n      // 4. \u7ACB\u5373\u66F4\u65B0\u5F53\u524D\u53EF\u89C1\u7684DOM\u5143\u7D20\n      const activeEl = this.activeMap.get(i);\n      if (activeEl) {\n          activeEl.style.width = `${this.colWidth}px`;\n          activeEl.style.transform = `translate3d(${x}px, ${y}px, 0)`;\n      }\n    }\n    this.config.data = data;\n    this.totalHeight = Math.max(...this.colHeights);\n    this.content.style.height = this.totalHeight + \"px\";\n    console.log(this.config.data)\n\n    this._onScroll(); // \u521D\u59CB\u6E32\u67D3\n  }\n\n  async _measure(el) {\n    const measurer = document.createElement(\"div\");\n    measurer.style.cssText =\n      \"position:absolute;visibility:hidden;pointer-events:none;\";\n    measurer.appendChild(el);\n    document.body.appendChild(measurer);\n\n    const imgs = el.querySelectorAll(\"img\");\n    if (imgs.length > 0) {\n      await Promise.all(\n        [...imgs].map(\n          (img) =>\n            new Promise((resolve) => {\n              img.onload = img.onerror = resolve;\n            })\n        )\n      );\n    }\n    const height = Math.floor(el.offsetHeight);\n    document.body.removeChild(measurer);\n    return height;\n  }\n\n  _onScroll() {\n    const scrollTop = this.el.scrollTop;\n    const buffer = this.config.buffer || 300;\n    const [start, end] = _getVisibleRange(\n      scrollTop,\n      this.viewportHeight,\n      buffer,\n      this.config.data,\n      this.config.column\n    );\n\n    // \u79FB\u9664\u4E0D\u5728\u8303\u56F4\u5185\u7684\u5143\u7D20\n    for (let [i, el] of this.activeMap.entries()) {\n      if (i < start || i > end) {\n        this.content.removeChild(el);\n        this.activeMap.delete(i);\n      }\n    }\n\n    // \u6279\u91CF\u521B\u5EFA fragment\n    const fragment = document.createDocumentFragment();\n    if (!this._pendingObservers) this._pendingObservers = [];\n    // \u6DFB\u52A0\u53EF\u89C1\u5143\u7D20\n    for (let i = start; i <= end; i++) {\n      if (!this.activeMap.has(i)) {\n        let el = this.domPool.get(i);\n        if (!el) {\n          el = this.config.renderItem(this.config.data[i]);\n          this.domPool.set(i, el);\n        }\n        const pos = this.config.data[i];\n\n        el.style.position = \"absolute\";\n        el.style.width = pos.width + \"px\";\n        el.style.transform = `translate3d(${pos.x}px, ${pos.y}px, 0)`;\n        this.activeMap.set(i, el);\n        fragment.appendChild(el);\n        this._pendingObservers.push(el);\n      }\n    }\n    this.content.appendChild(fragment);\n\n    // \u5EF6\u8FDF\u5904\u7406\u89C2\u5BDF\u52A8\u753B\n    cancelAnimationFrame(this._observerTimer);\n    this._observerTimer = requestAnimationFrame(() => {\n      this._pendingObservers.forEach((el) => observeVisibility.call(this, el));\n      this._pendingObservers = [];\n    });\n\n    // \u6E05\u7406 domPool\uFF08\u907F\u514D\u65E0\u9650\u589E\u957F\uFF09\n    if (this.domPool.size > this.MAX_DOM_POOL_SIZE) {\n      const keys = [...this.domPool.keys()];\n      for (let i = 0; i < keys.length - this.MAX_DOM_POOL_SIZE; i++) {\n        const index = keys[i];\n        if (!this.activeMap.has(index)) {\n          this.domPool.delete(index);\n        }\n      }\n    }\n  }\n\n  // \u8282\u6D41\u6EDA\u52A8\u4E8B\u4EF6\n  _onScrollThrottled() {\n    if (!this._ticking) {\n      this._ticking = true;\n      requestAnimationFrame(() => {\n        this._onScroll();\n        this._ticking = false;\n      });\n    }\n  }\n\n}\n"],
  "mappings": "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",
  "names": ["_getVisibleRange", "scrollTop", "viewportHeight", "buffer", "data", "overscanCount", "visibleTop", "visibleBottom", "start", "_binarySearch", "end", "targetY", "low", "high", "result", "mid", "observeVisibility", "el", "entry", "obs", "debounce", "func", "delay", "immediate", "timer", "hasCalled", "args", "context", "SuperVirtual", "config", "SuperVirtualList", "debounce", "content", "data", "renderItem", "gap", "column", "width", "i", "el", "measuredHeight", "minCol", "x", "y", "activeEl", "measurer", "imgs", "img", "resolve", "height", "scrollTop", "buffer", "start", "end", "_getVisibleRange", "fragment", "pos", "observeVisibility", "keys", "index"]
}
