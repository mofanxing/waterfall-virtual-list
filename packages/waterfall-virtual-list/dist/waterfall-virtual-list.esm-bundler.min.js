function t(t,e,i,s){return new(i||(i=Promise))((function(o,n){function l(t){try{r(s.next(t))}catch(t){n(t)}}function h(t){try{r(s.throw(t))}catch(t){n(t)}}function r(t){var e;t.done?o(t.value):(e=t.value,e instanceof i?e:new i((function(t){t(e)}))).then(l,h)}r((s=s.apply(t,e||[])).next())}))}function e(t,e){let i=0,s=e.length-1,o=e.length;for(;i<=s;){const n=Math.floor((i+s)/2);e[n].y>=t?(o=n,s=n-1):i=n+1}return o}function i(t,e){new IntersectionObserver((([i],s)=>{i.isIntersecting?(t.firstElementChild&&t.firstElementChild.classList.add(e),s.unobserve(t)):t.firstElementChild&&t.firstElementChild.classList.remove(e)}),{root:this.el,threshold:.1}).observe(t)}function s(t){return new o(t)}"function"==typeof SuppressedError&&SuppressedError;class o{constructor(t){this.config=t,this.el="string"==typeof t.el?document.querySelector(t.el):t.el,this.colHeights=Array(t.column).fill(0),this.totalHeight=0,this.colWidth=0,this.content=null,this.activeMap=new Map,this.domPool=new Map,this.viewportHeight=this.config.viewportHeight,this.MAX_DOM_POOL_SIZE=this.config.maxDomPoolSize||300,this._pendingObservers=[],this._observerTimer=null,this._ticking=!1,this.isUpdate=!1,this._initData(t)}_initData(e){return t(this,void 0,void 0,(function*(){"function"==typeof e.data?this.data=yield e.data():this.data=e.data,this._onScrollThrottled=function(t,e,i={}){let s,o,n=null,l=0;const h=()=>{l=!1===i.leading?0:Date.now(),n=null,t.apply(s,o),s=o=null},r=function(...r){const a=Date.now();l||!1!==i.leading||(l=a);const c=e-(a-l);s=this,o=r,c<=0||c>e?(n&&(clearTimeout(n),n=null),l=a,t.apply(s,o),s=o=null):n||!1===i.trailing||(n=setTimeout(h,c))};return r.cancel=()=>{clearTimeout(n),n=null,l=0},r}(this._onScroll.bind(this),100),this._init_el(),this._debouncedRecalculate=function(t,e,i=!1){let s=null,o=!1;return function(...n){const l=this;!i||s||o||(t.apply(l,n),o=!0),null!==s&&clearTimeout(s),s=setTimeout((()=>{i||t.apply(l,n),s=null,o=!1}),e)}}(this._init.bind(this),200),this.el.addEventListener("scroll",this._onScrollThrottled),this.resizeObserver=new ResizeObserver((()=>this._debouncedRecalculate())),this.resizeObserver.observe(this.el)}))}_init_el(){this.el.style.cssText=`overflow-y: scroll;height: ${this.viewportHeight}px;`;let t=document.createElement("div");t.className="content",t.style.cssText="position: relative;width: 100%;",this.el.appendChild(t),this.content=t}_init(){return t(this,void 0,void 0,(function*(){this.colHeights=Array(this.config.column).fill(0),this.totalHeight=0;let t=this.data,{renderItem:e,gap:i,column:s}=this.config,o=Math.floor((this.el.clientWidth-(s-1)*i)/this.config.column);this.colWidth=o;for(let s=0;s<t.length;s++){const n=e(t[s]);n.style.width=o+"px";const l=yield this._measure(n),h=this.colHeights.indexOf(Math.min(...this.colHeights)),r=Math.floor(h*(o+i)),a=Math.floor(this.colHeights[h]);t[s].height=l,t[s].x=r,t[s].y=a,t[s].width=o,this.colHeights[h]+=l+i;const c=this.activeMap.get(s);c&&(c.style.width=`${this.colWidth}px`,c.style.transform=`translate3d(${r}px, ${a}px, 0)`)}this.data=t,this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",requestAnimationFrame((()=>{this._onScroll()}))}))}updateData(e){return t(this,void 0,void 0,(function*(){let{renderItem:t,gap:i}=this.config,s=this.colWidth;for(let o=0;o<e.length;o++){const n=t(e[o]);n.style.width=s+"px";const l=yield this._measure(n),h=this.colHeights.indexOf(Math.min(...this.colHeights)),r=Math.floor(h*(s+i)),a=Math.floor(this.colHeights[h]);e[o].height=l,e[o].x=r,e[o].y=a,e[o].width=s,this.colHeights[h]+=l+i}this.data.push(...e),this.totalHeight=Math.max(...this.colHeights),this.content.style.height=this.totalHeight+"px",requestAnimationFrame((()=>{this._onScroll()}))}))}_measure(e){return t(this,void 0,void 0,(function*(){const t=document.createElement("div");t.style.cssText="position:absolute;visibility:hidden;pointer-events:none;",t.appendChild(e),document.body.appendChild(t);const i=e.querySelectorAll("img");i.length>0&&(yield Promise.all([...i].map((t=>new Promise((e=>{t.onload=t.onerror=e}))))));const s=Math.floor(e.offsetHeight);return document.body.removeChild(t),s}))}_setElementStyle(t,{x:e,y:i,width:s}){t.style.width=s+"px",t.style.transform=`translate3d(${e}px, ${i}px, 0)`}_onScroll(){const t=this.el.scrollTop,s=this.config.buffer||300,[o,n]=function(t,i,s=100,o=[],n=0){const l=t+i+s,h=e(t-s,o),r=e(l,o);return[Math.max(0,h-n),Math.min(o.length-1,r+n)]}(t,this.viewportHeight,s,this.data,this.config.column);for(let[t,e]of this.activeMap.entries())(t<o||t>n)&&(this.content.removeChild(e),this.activeMap.delete(t));const l=document.createDocumentFragment();this._pendingObservers||(this._pendingObservers=[]);for(let t=o;t<=n;t++)if(!this.activeMap.has(t)){let e=this.domPool.get(t);e||(e=this.config.renderItem(this.data[t]),this.domPool.set(t,e));const i=this.data[t];e.style.position="absolute",this._setElementStyle(e,{width:i.width,x:i.x,y:i.y}),this.activeMap.set(t,e),l.appendChild(e),this._pendingObservers.push(e)}if(this.content.appendChild(l),cancelAnimationFrame(this._observerTimer),this._observerTimer=requestAnimationFrame((()=>{this._pendingObservers.forEach((t=>i.call(this,t,this.config.animeClass))),this._pendingObservers=[]})),this.domPool.size>this.MAX_DOM_POOL_SIZE){const t=[...this.domPool.keys()];for(let e=0;e<t.length-this.MAX_DOM_POOL_SIZE;e++){const i=t[e];this.activeMap.has(i)||this.domPool.delete(i)}}this.isScrollBottom()}isScrollBottom(){return t(this,void 0,void 0,(function*(){const t=this.el;if(t.scrollTop+t.clientHeight>=t.scrollHeight-50&&!this.isUpdate&&this.config.scrollToBottom){this.isUpdate=!0;try{let t=yield this.config.scrollToBottom();t.length&&(yield this.updateData(t))}finally{this.isUpdate=!1}}}))}}export{s as default};
